version: "1.0"

# ============================================================================
# è‡ªåŠ¨åŒ–æµ‹è¯•è§„åˆ™é…ç½®æ–‡ä»¶ (ä½¿ç”¨ ~ ä½œä¸ºåˆ†éš”ç¬¦)
# ============================================================================
# 
# è¯´æ˜ï¼šæœ¬é…ç½®æ–‡ä»¶å®šä¹‰äº†è‡ªåŠ¨åŒ–æµ‹è¯•ä¸­å¯ä½¿ç”¨çš„å„ç§æ“ä½œè§„åˆ™
# 
# å¯ç”¨å˜é‡ï¼š
# - $page          : å½“å‰æ´»åŠ¨é¡µé¢å¯¹è±¡ (Playwright Page)
# - $stagehand     : Stagehand å®ä¾‹ï¼Œæä¾› AI å¢å¼ºçš„æ“ä½œæ–¹æ³•
# - $context       : ä¸Šä¸‹æ–‡ç®¡ç†å¯¹è±¡ï¼Œç”¨äºå¤šæ ‡ç­¾é¡µç®¡ç†
# - $title         : å½“å‰é¡µé¢æ ‡é¢˜
# - $url           : å½“å‰é¡µé¢ URL
# - fs, path, z, expect : è¾…åŠ©å·¥å…·åº“
#
# è§„åˆ™æ ¼å¼è¯´æ˜ï¼š
# - ä½¿ç”¨ ~ æ³¢æµªå·ä½œä¸ºåˆ†éš”ç¬¦ï¼ˆæ— ä¸­è‹±æ–‡æ··æ·†ï¼‰
# - patterns ä¸­ {å˜é‡å} è¡¨ç¤ºå‚æ•°å ä½ç¬¦
# - template ä¸ºæ‰§è¡Œæ¨¡æ¿ï¼Œå¯ä½¿ç”¨ä¸Šè¿°å˜é‡å’Œå‚æ•°
# ============================================================================

rules:
  # ==========================================================================
  # é¡µé¢å¯¼èˆªç±»æ“ä½œ
  # ==========================================================================
  
  - name: "goto_url"
    description: "æ‰“å¼€æŒ‡å®š URL çš„æ–°æ ‡ç­¾é¡µ"
    patterns:
      - "æ‰“å¼€~{url}"
      - "è®¿é—®~{url}"
      - "å¯¼èˆªåˆ°~{url}"
      - "æ‰“å¼€~{label}~{url}"
      - "è®¿é—®~{label}~{url}"
    template: |
      await $context.newPage('{url}');
    validation:
      required: ["url"]
    examples:
      - "æ‰“å¼€~https://www.example.com"
      - "è®¿é—®~ç™»å½•é¡µ~https://app.example.com/login"

  - name: "goto_current_page"
    description: "åœ¨å½“å‰é¡µé¢å¯¼èˆªåˆ°æ–° URL"
    patterns:
      - "å½“å‰é¡µé¢æ‰“å¼€~{url}"
      - "å½“å‰é¡µé¢è®¿é—®~{url}"
      - "è·³è½¬åˆ°~{url}"
    template: |
      await $page.goto('{url}');
    validation:
      required: ["url"]

  - name: "go_back"
    description: "è¿”å›ä¸Šä¸€é¡µ"
    patterns:
      - "è¿”å›"
      - "åé€€"
    template: |
      await $page.goBack();
    validation:
      required: []

  - name: "go_forward"
    description: "å‰è¿›åˆ°ä¸‹ä¸€é¡µ"
    patterns:
      - "å‰è¿›"
    template: |
      await $page.goForward();
    validation:
      required: []

  - name: "reload_page"
    description: "åˆ·æ–°å½“å‰é¡µé¢"
    patterns:
      - "åˆ·æ–°"
      - "é‡æ–°åŠ è½½"
    template: |
      await $page.reload();
    validation:
      required: []

  # ==========================================================================
  # è¡¨å•è¾“å…¥ç±»æ“ä½œ
  # ==========================================================================

  - name: "input_action"
    description: "åœ¨æŒ‡å®šå­—æ®µä¸­è¾“å…¥å†…å®¹ (AI å¢å¼º)"
    patterns:
      - "åœ¨{field}ä¸­è¾“å…¥~{value}"
      - "è¾“å…¥~{value}~åˆ°{field}"
    template: |
      await $stagehand.act('åœ¨ {field} ä¸­è¾“å…¥ {value}', $page)
    validation:
      required: ["field", "value"]
    examples:
      - "åœ¨ç”¨æˆ·åä¸­è¾“å…¥~admin"
      - "è¾“å…¥~test@example.com~åˆ°é‚®ç®±å­—æ®µ"

  - name: "fill_input"
    description: "ä½¿ç”¨é€‰æ‹©å™¨å¡«å……è¾“å…¥æ¡†"
    patterns:
      - "å¡«å……~{selector}~{value}"
      - "è®¾ç½®~{selector}~ä¸º~{value}"
    template: |
      await $page.locator('{selector}').fill('{value}');
    validation:
      required: ["selector", "value"]
    examples:
      - "å¡«å……~#username~admin"
      - "è®¾ç½®~input[name='email']~ä¸º~test@example.com"

  - name: "type_text"
    description: "æ¨¡æ‹Ÿé”®ç›˜é€å­—è¾“å…¥"
    patterns:
      - "é”®å…¥~{selector}~{value}"
      - "é€å­—è¾“å…¥~{selector}~{value}"
    template: |
      await $page.locator('{selector}').type('{value}', { delay: 100 });
    validation:
      required: ["selector", "value"]

  - name: "clear_input"
    description: "æ¸…ç©ºè¾“å…¥æ¡†å†…å®¹"
    patterns:
      - "æ¸…ç©º~{selector}"
      - "æ¸…é™¤~{selector}"
    template: |
      await $page.locator('{selector}').clear();
    validation:
      required: ["selector"]

  # ==========================================================================
  # ç‚¹å‡»ç±»æ“ä½œ
  # ==========================================================================

  - name: "click_action"
    description: "AI é©±åŠ¨çš„æ™ºèƒ½ç‚¹å‡»"
    patterns:
      - "ç‚¹å‡»~{target}"
      - "å•å‡»~{target}"
    template: |
      await $stagehand.act('ç‚¹å‡» {target}', $page)
    validation:
      required: ["target"]
    examples:
      - "ç‚¹å‡»~ç™»å½•æŒ‰é’®"
      - "å•å‡»~æäº¤"

  - name: "locator_click"
    description: "ä½¿ç”¨é€‰æ‹©å™¨ç²¾ç¡®ç‚¹å‡»"
    patterns:
      - "æŠ€æœ¯ç‚¹å‡»~{selector}"
      - "å®šä½ç‚¹å‡»~{selector}"
    template: |
      await $page.locator('{selector}').click();
    validation:
      required: ["selector"]
    examples:
      - "æŠ€æœ¯ç‚¹å‡»~button[type='submit']"
      - "å®šä½ç‚¹å‡»~#login-btn"

  - name: "double_click"
    description: "åŒå‡»å…ƒç´ "
    patterns:
      - "åŒå‡»~{selector}"
    template: |
      await $page.locator('{selector}').dblclick();
    validation:
      required: ["selector"]

  - name: "right_click"
    description: "å³é”®ç‚¹å‡»å…ƒç´ "
    patterns:
      - "å³é”®~{selector}"
      - "å³é”®ç‚¹å‡»~{selector}"
    template: |
      await $page.locator('{selector}').click({ button: 'right' });
    validation:
      required: ["selector"]

  - name: "hover"
    description: "é¼ æ ‡æ‚¬åœ"
    patterns:
      - "æ‚¬åœ~{selector}"
      - "é¼ æ ‡ç§»åˆ°~{selector}"
    template: |
      await $page.locator('{selector}').hover();
    validation:
      required: ["selector"]

  # ==========================================================================
  # é€‰æ‹©ç±»æ“ä½œ
  # ==========================================================================

  - name: "select_option"
    description: "ä¸‹æ‹‰æ¡†é€‰æ‹©"
    patterns:
      - "é€‰æ‹©~{selector}~{value}"
      - "ä¸‹æ‹‰é€‰æ‹©~{selector}~{value}"
    template: |
      await $page.locator('{selector}').selectOption('{value}');
    validation:
      required: ["selector", "value"]
    examples:
      - "é€‰æ‹©~#country~China"

  - name: "check_checkbox"
    description: "å‹¾é€‰å¤é€‰æ¡†"
    patterns:
      - "å‹¾é€‰~{selector}"
      - "é€‰ä¸­~{selector}"
    template: |
      await $page.locator('{selector}').check();
    validation:
      required: ["selector"]

  - name: "uncheck_checkbox"
    description: "å–æ¶ˆå‹¾é€‰å¤é€‰æ¡†"
    patterns:
      - "å–æ¶ˆå‹¾é€‰~{selector}"
      - "å–æ¶ˆé€‰ä¸­~{selector}"
    template: |
      await $page.locator('{selector}').uncheck();
    validation:
      required: ["selector"]

  # ==========================================================================
  # ç­‰å¾…ç±»æ“ä½œ
  # ==========================================================================

  - name: "wait_ms"
    description: "ç­‰å¾…æŒ‡å®šæ¯«ç§’æ•°"
    patterns:
      - "ç­‰å¾…~{ms}~æ¯«ç§’"
      - "ç­‰å¾…~{ms}~ms"
      - "æš‚åœ~{ms}~æ¯«ç§’"
    template: |
      await new Promise(r => setTimeout(r, {ms}));
    validation:
      required: ["ms"]
    examples:
      - "ç­‰å¾…~2000~æ¯«ç§’"

  - name: "wait_for_selector"
    description: "ç­‰å¾…å…ƒç´ å‡ºç°"
    patterns:
      - "ç­‰å¾…å…ƒç´ ~{selector}"
      - "ç­‰å¾…å‡ºç°~{selector}"
    template: |
      await $page.waitForSelector('{selector}', { timeout: 30000 });
    validation:
      required: ["selector"]

  - name: "wait_for_text"
    description: "ç­‰å¾…æ–‡æœ¬å‡ºç°"
    patterns:
      - "ç­‰å¾…æ–‡æœ¬~{text}"
      - "ç­‰å¾…åŒ…å«~{text}"
    template: |
      await $page.waitForSelector(\`text={text}\`, { timeout: 30000 });
    validation:
      required: ["text"]

  - name: "wait_for_navigation"
    description: "ç­‰å¾…é¡µé¢å¯¼èˆªå®Œæˆ"
    patterns:
      - "ç­‰å¾…å¯¼èˆª"
      - "ç­‰å¾…é¡µé¢åŠ è½½"
    template: |
      await $page.waitForLoadState('networkidle');
    validation:
      required: []

  - name: "wait_for_url"
    description: "ç­‰å¾… URL åŒ…å«æŒ‡å®šå†…å®¹"
    patterns:
      - "ç­‰å¾…URL~{urlPart}"
      - "ç­‰å¾…åœ°å€åŒ…å«~{urlPart}"
    template: |
      await $page.waitForURL('**/{urlPart}**', { timeout: 30000 });
    validation:
      required: ["urlPart"]

  # ==========================================================================
  # æˆªå›¾ä¸è§†è§‰éªŒè¯
  # ==========================================================================

  - name: "screenshot"
    description: "æˆªå–æ•´é¡µæˆªå›¾å¹¶ä¿å­˜"
    patterns:
      - "æˆªå›¾~ä¿å­˜ä¸º~{imagefilename}"
      - "æˆªå±~ä¿å­˜ä¸º~{imagefilename}"
      - "ä¿å­˜æˆªå›¾~{imagefilename}"
    template: |
      await (async () => {
        const screenshotBuffer = await $page.screenshot({ fullPage: true });
        fs.mkdirSync('results/screenshots', { recursive: true });
        const filePath = path.join(process.cwd(), 'results/screenshots', '{imagefilename}.png');
        fs.writeFileSync(filePath, screenshotBuffer);
        console.log(`   ğŸ“¸ æˆªå›¾å·²ä¿å­˜: ${filePath}`);
        return filePath;
      })()
    validation:
      required: ["imagefilename"]
    examples:
      - "æˆªå›¾~ä¿å­˜ä¸º~login-page"

  - name: "screenshot_element"
    description: "æˆªå–æŒ‡å®šå…ƒç´ çš„æˆªå›¾"
    patterns:
      - "æˆªå–å…ƒç´ ~{selector}~ä¿å­˜ä¸º~{imagefilename}"
    template: |
      await (async () => {
        const element = $page.locator('{selector}');
        const screenshotBuffer = await element.screenshot();
        fs.mkdirSync('results/screenshots', { recursive: true });
        const filePath = path.join(process.cwd(), 'results/screenshots', '{imagefilename}.png');
        fs.writeFileSync(filePath, screenshotBuffer);
        console.log(\`   ğŸ“¸ å…ƒç´ æˆªå›¾å·²ä¿å­˜: \${filePath}\`);
        return filePath;
      })()
    validation:
      required: ["selector", "imagefilename"]

  # ==========================================================================
  # æ•°æ®æå–ç±»æ“ä½œ
  # ==========================================================================

  - name: "default_extract"
    description: "AI æå–é¡µé¢æ•°æ® (æ— ç»“æ„)"
    patterns:
      - "æ‘˜å½•~{action}"
      - "æå–~{action}"
    template: |
      await $stagehand.extract('{action}')
    validation:
      required: ["action"]
    examples:
      - "æ‘˜å½•~é¡µé¢ä¸Šæ‰€æœ‰äº§å“çš„åç§°å’Œä»·æ ¼"
      - "æå–~ç”¨æˆ·çš„ä¸ªäººä¿¡æ¯"

  - name: "default_extract_with_schema"
    description: "AI æå–é¡µé¢æ•°æ® (å¸¦ Zod Schema)"
    patterns:
      - "æ‘˜å½•~{action}~{schema}"
      - "æå–~{action}~{schema}"
    template: |
      await $stagehand.extract('{action}', {schema})
    validation:
      required: ["action", "schema"]
    examples:
      - "æ‘˜å½•~æå–ç”¨æˆ·ä¿¡æ¯~z.object({name: z.string(), email: z.string()})"

  - name: "get_text"
    description: "è·å–å…ƒç´ æ–‡æœ¬å†…å®¹"
    patterns:
      - "è·å–æ–‡æœ¬~{selector}"
      - "è¯»å–æ–‡æœ¬~{selector}"
    template: |
      await $page.locator('{selector}').textContent()
    validation:
      required: ["selector"]

  - name: "get_attribute"
    description: "è·å–å…ƒç´ å±æ€§å€¼"
    patterns:
      - "è·å–å±æ€§~{selector}~{attribute}"
      - "è¯»å–å±æ€§~{selector}~{attribute}"
    template: |
      await $page.locator('{selector}').getAttribute('{attribute}')
    validation:
      required: ["selector", "attribute"]
    examples:
      - "è·å–å±æ€§~#link~href"

  - name: "get_value"
    description: "è·å–è¾“å…¥æ¡†çš„å€¼"
    patterns:
      - "è·å–å€¼~{selector}"
      - "è¯»å–å€¼~{selector}"
    template: |
      await $page.locator('{selector}').inputValue()
    validation:
      required: ["selector"]

  - name: "get_count"
    description: "è·å–åŒ¹é…å…ƒç´ çš„æ•°é‡"
    patterns:
      - "ç»Ÿè®¡~{selector}"
      - "è®¡æ•°~{selector}"
    template: |
      await $page.locator('{selector}').count()
    validation:
      required: ["selector"]

  # ==========================================================================
  # è§‚å¯Ÿä¸æ–­è¨€ç±»æ“ä½œ
  # ==========================================================================

  - name: "default_observe"
    description: "AI è§‚å¯Ÿé¡µé¢å…ƒç´ åŠå¯ç”¨æ“ä½œ"
    patterns:
      - "è§‚å¯Ÿ~{action}"
    template: |
      await $stagehand.observe('{action}')
    validation:
      required: ["action"]
    examples:
      - "è§‚å¯Ÿ~é¡µé¢ä¸Šçš„æ‰€æœ‰æŒ‰é’®"

  - name: "default_observe_expect"
    description: "è§‚å¯Ÿå¹¶æ–­è¨€æœ‰å¯ç”¨æ“ä½œ"
    patterns:
      - "æ–­è¨€~{action}"
    template: |
      await (async () => {
        const actions = await $stagehand.observe('{action}');
        expect(actions.length, 'æœªæ‰¾åˆ°ä»»ä½•å¯ç”¨æ“ä½œ').to.be.greaterThan(0);
        return actions;
      })()
    validation:
      required: ["action"]
    examples:
      - "æ–­è¨€~é¡µé¢æœ‰ç™»å½•æŒ‰é’®"

  - name: "assert_visible"
    description: "æ–­è¨€å…ƒç´ å¯è§"
    patterns:
      - "æ–­è¨€å¯è§~{selector}"
      - "åº”è¯¥å¯è§~{selector}"
    template: |
      await (async () => {
        const isVisible = await $page.locator('{selector}').isVisible();
        expect(isVisible, 'å…ƒç´  {selector} åº”è¯¥å¯è§').to.be.true;
        return isVisible;
      })()
    validation:
      required: ["selector"]

  - name: "assert_hidden"
    description: "æ–­è¨€å…ƒç´ ä¸å¯è§"
    patterns:
      - "æ–­è¨€éšè—~{selector}"
      - "åº”è¯¥éšè—~{selector}"
    template: |
      await (async () => {
        const isHidden = await $page.locator('{selector}').isHidden();
        expect(isHidden, 'å…ƒç´  {selector} åº”è¯¥éšè—').to.be.true;
        return isHidden;
      })()
    validation:
      required: ["selector"]

  - name: "assert_text_contains"
    description: "æ–­è¨€å…ƒç´ åŒ…å«æŒ‡å®šæ–‡æœ¬"
    patterns:
      - "æ–­è¨€åŒ…å«æ–‡æœ¬~{selector}~{text}"
      - "åº”è¯¥åŒ…å«~{selector}~{text}"
    template: |
      await (async () => {
        const actualText = await $page.locator('{selector}').textContent();
        expect(actualText, \`å…ƒç´  {selector} åº”åŒ…å«æ–‡æœ¬ "{text}"\`).to.include('{text}');
        return actualText;
      })()
    validation:
      required: ["selector", "text"]

  - name: "assert_text_equals"
    description: "æ–­è¨€å…ƒç´ æ–‡æœ¬å®Œå…¨åŒ¹é…"
    patterns:
      - "æ–­è¨€æ–‡æœ¬ç­‰äº~{selector}~{text}"
      - "æ–‡æœ¬åº”è¯¥æ˜¯~{selector}~{text}"
    template: |
      await (async () => {
        const actualText = (await $page.locator('{selector}').textContent()).trim();
        expect(actualText, \`å…ƒç´  {selector} çš„æ–‡æœ¬åº”è¯¥æ˜¯ "{text}"\`).to.equal('{text}');
        return actualText;
      })()
    validation:
      required: ["selector", "text"]

  - name: "assert_count"
    description: "æ–­è¨€å…ƒç´ æ•°é‡"
    patterns:
      - "æ–­è¨€æ•°é‡~{selector}~{count}"
      - "åº”è¯¥æœ‰~{count}~ä¸ª~{selector}"
    template: |
      await (async () => {
        const actualCount = await $page.locator('{selector}').count();
        expect(actualCount, \`åº”è¯¥æœ‰ {count} ä¸ªå…ƒç´ åŒ¹é… {selector}\`).to.equal(parseInt('{count}'));
        return actualCount;
      })()
    validation:
      required: ["selector", "count"]

  - name: "assert_url_contains"
    description: "æ–­è¨€ URL åŒ…å«æŒ‡å®šå†…å®¹"
    patterns:
      - "æ–­è¨€URLåŒ…å«~{urlPart}"
      - "åœ°å€åº”è¯¥åŒ…å«~{urlPart}"
    template: |
      await (async () => {
        const currentUrl = $page.url();
        expect(currentUrl, \`URL åº”è¯¥åŒ…å« "{urlPart}"\`).to.include('{urlPart}');
        return currentUrl;
      })()
    validation:
      required: ["urlPart"]

  - name: "assert_title"
    description: "æ–­è¨€é¡µé¢æ ‡é¢˜"
    patterns:
      - "æ–­è¨€æ ‡é¢˜~{title}"
      - "æ ‡é¢˜åº”è¯¥æ˜¯~{title}"
    template: |
      await (async () => {
        const actualTitle = await $page.title();
        expect(actualTitle, \`é¡µé¢æ ‡é¢˜åº”è¯¥æ˜¯ "{title}"\`).to.equal('{title}');
        return actualTitle;
      })()
    validation:
      required: ["title"]

  - name: "assert_attribute"
    description: "æ–­è¨€å…ƒç´ å±æ€§å€¼"
    patterns:
      - "æ–­è¨€å±æ€§~{selector}~{attribute}~{value}"
      - "å±æ€§åº”è¯¥æ˜¯~{selector}~{attribute}~{value}"
    template: |
      await (async () => {
        const actualValue = await $page.locator('{selector}').getAttribute('{attribute}');
        expect(actualValue, \`å…ƒç´  {selector} çš„ {attribute} å±æ€§åº”è¯¥æ˜¯ "{value}"\`).to.equal('{value}');
        return actualValue;
      })()
    validation:
      required: ["selector", "attribute", "value"]

  - name: "assert_checked"
    description: "æ–­è¨€å¤é€‰æ¡†å·²é€‰ä¸­"
    patterns:
      - "æ–­è¨€å·²é€‰ä¸­~{selector}"
      - "åº”è¯¥è¢«å‹¾é€‰~{selector}"
    template: |
      await (async () => {
        const isChecked = await $page.locator('{selector}').isChecked();
        expect(isChecked, \`å…ƒç´  {selector} åº”è¯¥è¢«é€‰ä¸­\`).to.be.true;
        return isChecked;
      })()
    validation:
      required: ["selector"]

  - name: "assert_enabled"
    description: "æ–­è¨€å…ƒç´ å¯ç”¨"
    patterns:
      - "æ–­è¨€å¯ç”¨~{selector}"
      - "åº”è¯¥å¯ç”¨~{selector}"
    template: |
      await (async () => {
        const isEnabled = await $page.locator('{selector}').isEnabled();
        expect(isEnabled, \`å…ƒç´  {selector} åº”è¯¥å¯ç”¨\`).to.be.true;
        return isEnabled;
      })()
    validation:
      required: ["selector"]

  - name: "assert_disabled"
    description: "æ–­è¨€å…ƒç´ ç¦ç”¨"
    patterns:
      - "æ–­è¨€ç¦ç”¨~{selector}"
      - "åº”è¯¥ç¦ç”¨~{selector}"
    template: |
      await (async () => {
        const isDisabled = await $page.locator('{selector}').isDisabled();
        expect(isDisabled, \`å…ƒç´  {selector} åº”è¯¥è¢«ç¦ç”¨\`).to.be.true;
        return isDisabled;
      })()
    validation:
      required: ["selector"]

  # ==========================================================================
  # å¤šæ ‡ç­¾é¡µç®¡ç†
  # ==========================================================================

  - name: "context_newPage"
    description: "åˆ›å»ºæ–°æ ‡ç­¾é¡µ"
    patterns:
      - "æ ‡ç­¾~æ–°é¡µé¢~{url}"
      - "ä¸Šä¸‹æ–‡~æ–°é¡µé¢~{url}"
      - "æ–°å»ºæ ‡ç­¾é¡µ~{url}"
    template: |
      await $context.newPage('{url}')
    validation:
      required: ["url"]

  - name: "context_pages"
    description: "åˆ—å‡ºæ‰€æœ‰æ ‡ç­¾é¡µçš„æ ‡é¢˜"
    patterns:
      - "æ ‡ç­¾~å…¨éƒ¨é¡µé¢"
      - "ä¸Šä¸‹æ–‡~å…¨éƒ¨é¡µé¢"
      - "åˆ—å‡ºæ‰€æœ‰æ ‡ç­¾é¡µ"
    template: |
      await (async () => {
        const retArray = [];
        const pages = $context.pages();
        for (const page of pages) {
          const pageTitle = await page.title();
          retArray.push(pageTitle);
        }
        return retArray;
      })()
    validation:
      required: []

  - name: "context_Pages_by_title"
    description: "æ ¹æ®æ ‡é¢˜ç­›é€‰æ ‡ç­¾é¡µ"
    patterns:
      - "æ ‡ç­¾~å…¨éƒ¨é¡µé¢~{title}"
      - "ä¸Šä¸‹æ–‡~å…¨éƒ¨é¡µé¢~{title}"
      - "æŸ¥æ‰¾æ ‡ç­¾é¡µ~{title}"
    template: |
      await (async () => {
        const retArray = [];
        const pages = $context.pages();
        for (const page of pages) {
          const pageTitle = await page.title();
          if (pageTitle.includes('{title}')) {
            retArray.push(pageTitle);
          }
        }
        return retArray;
      })()
    validation:
      required: ["title"]

  - name: "context_close_pages_by_title"
    description: "æ ¹æ®æ ‡é¢˜å…³é—­æ ‡ç­¾é¡µ"
    patterns:
      - "æ ‡ç­¾~å…³é—­é¡µé¢~{title}"
      - "ä¸Šä¸‹æ–‡~å…³é—­é¡µé¢~{title}"
      - "å…³é—­æ ‡ç­¾é¡µ~{title}"
    template: |
      await (async () => {
        const retArray = [];
        const pages = $context.pages();
        for (const page of pages) {
          const pageTitle = await page.title();
          if (pageTitle.includes('{title}')) {
            await page.close();
            retArray.push(pageTitle);
          }
        }
        return retArray;
      })()
    validation:
      required: ["title"]

  - name: "context_active_page_by_title"
    description: "åˆ‡æ¢åˆ°æŒ‡å®šæ ‡é¢˜çš„æ ‡ç­¾é¡µ"
    patterns:
      - "æ ‡ç­¾~åˆ‡æ¢é¡µé¢~{title}"
      - "ä¸Šä¸‹æ–‡~åˆ‡æ¢é¡µé¢~{title}"
      - "åˆ‡æ¢åˆ°æ ‡ç­¾é¡µ~{title}"
    template: |
      await (async () => {
        const pages = $context.pages();
        for (const page of pages) {
          const pageTitle = await page.title();
          if (pageTitle.includes('{title}')) {
            $context.setActivePage(page);
            const title = await $context.activePage()?.title();
            return { title, result: true };
          }
        }
        return { title: null, result: false };
      })()
    validation:
      required: ["title"]

  # ==========================================================================
  # é”®ç›˜ä¸é¼ æ ‡æ“ä½œ
  # ==========================================================================

  - name: "press_key"
    description: "æŒ‰ä¸‹é”®ç›˜æŒ‰é”®"
    patterns:
      - "æŒ‰é”®~{key}"
      - "æŒ‰ä¸‹~{key}"
    template: |
      await $page.keyboard.press('{key}');
    validation:
      required: ["key"]
    examples:
      - "æŒ‰é”®~Enter"
      - "æŒ‰ä¸‹~Escape"

  - name: "keyboard_type"
    description: "é”®ç›˜è¾“å…¥æ–‡æœ¬"
    patterns:
      - "é”®ç›˜è¾“å…¥~{text}"
    template: |
      await $page.keyboard.type('{text}', { delay: 100 });
    validation:
      required: ["text"]

  - name: "scroll_to"
    description: "æ»šåŠ¨åˆ°å…ƒç´ ä½ç½®"
    patterns:
      - "æ»šåŠ¨åˆ°~{selector}"
    template: |
      await $page.locator('{selector}').scrollIntoViewIfNeeded();
    validation:
      required: ["selector"]

  - name: "scroll_page"
    description: "æ»šåŠ¨é¡µé¢"
    patterns:
      - "æ»šåŠ¨~{direction}"
    template: |
      await (async () => {
        const direction = '{direction}'.toLowerCase();
        if (direction === 'åº•éƒ¨' || direction === 'ä¸‹') {
          await $page.evaluate(() => window.scrollTo(0, document.body.scrollHeight));
        } else if (direction === 'é¡¶éƒ¨' || direction === 'ä¸Š') {
          await $page.evaluate(() => window.scrollTo(0, 0));
        }
      })()
    validation:
      required: ["direction"]
    examples:
      - "æ»šåŠ¨~åº•éƒ¨"
      - "æ»šåŠ¨~é¡¶éƒ¨"

  # ==========================================================================
  # æ–‡ä»¶æ“ä½œ
  # ==========================================================================

  - name: "upload_file"
    description: "ä¸Šä¼ æ–‡ä»¶"
    patterns:
      - "ä¸Šä¼ æ–‡ä»¶~{selector}~{filepath}"
    template: |
      await $page.locator('{selector}').setInputFiles('{filepath}');
    validation:
      required: ["selector", "filepath"]

  - name: "download_file"
    description: "ç­‰å¾…å¹¶ä¿å­˜ä¸‹è½½çš„æ–‡ä»¶"
    patterns:
      - "ä¸‹è½½æ–‡ä»¶~ä¿å­˜ä¸º~{filename}"
    template: |
      await (async () => {
        const downloadPromise = $page.waitForEvent('download');
        const download = await downloadPromise;
        const filePath = path.join(process.cwd(), 'results/downloads', '{filename}');
        fs.mkdirSync(path.dirname(filePath), { recursive: true });
        await download.saveAs(filePath);
        console.log(\`   ğŸ’¾ æ–‡ä»¶å·²ä¸‹è½½: \${filePath}\`);
        return filePath;
      })()
    validation:
      required: ["filename"]

  # ==========================================================================
  # Cookie å’Œå­˜å‚¨æ“ä½œ
  # ==========================================================================

  - name: "get_cookies"
    description: "è·å–æ‰€æœ‰ Cookie"
    patterns:
      - "è·å–Cookie"
      - "è¯»å–Cookie"
    template: |
      await $context.context.cookies()
    validation:
      required: []

  - name: "add_cookie"
    description: "æ·»åŠ  Cookie"
    patterns:
      - "æ·»åŠ Cookie~{name}~{value}"
    template: |
      await $context.context.addCookies([{ name: '{name}', value: '{value}', url: $page.url() }])
    validation:
      required: ["name", "value"]

  - name: "clear_cookies"
    description: "æ¸…é™¤æ‰€æœ‰ Cookie"
    patterns:
      - "æ¸…é™¤Cookie"
    template: |
      await $context.context.clearCookies()
    validation:
      required: []

  # ==========================================================================
  # æ‰§è¡Œ JavaScript
  # ==========================================================================

  - name: "execute_script"
    description: "åœ¨é¡µé¢æ‰§è¡Œ JavaScript"
    patterns:
      - "JS|~{script}"
      - "è„šæœ¬|~{script}"
    template: |
      await $page.evaluate(() => { {script} })
    validation:
      required: ["script"]
    examples:
      - "JS|~console.log('Hello')"

  - name: "evaluate_with_result"
    description: "æ‰§è¡Œ JavaScript å¹¶è¿”å›ç»“æœ"
    patterns:
      - "è®¡ç®—~{script}"
      - "æ‰§è¡Œå¹¶è¿”å›~{script}"
    template: |
      await $page.evaluate(() => { return {script}; })
    validation:
      required: ["script"]

  # ==========================================================================
  # å¯¹è¯æ¡†å¤„ç†
  # ==========================================================================

  - name: "accept_dialog"
    description: "æ¥å—å¯¹è¯æ¡†ï¼ˆalert/confirmï¼‰"
    patterns:
      - "æ¥å—å¯¹è¯æ¡†"
      - "ç¡®è®¤å¯¹è¯æ¡†"
    template: |
      await (async () => {
        $page.once('dialog', dialog => dialog.accept());
        return true;
      })()
    validation:
      required: []

  - name: "dismiss_dialog"
    description: "å–æ¶ˆå¯¹è¯æ¡†"
    patterns:
      - "å–æ¶ˆå¯¹è¯æ¡†"
      - "æ‹’ç»å¯¹è¯æ¡†"
    template: |
      await (async () => {
        $page.once('dialog', dialog => dialog.dismiss());
        return true;
      })()
    validation:
      required: []

  - name: "accept_dialog_with_text"
    description: "æ¥å—å¯¹è¯æ¡†å¹¶è¾“å…¥æ–‡æœ¬ï¼ˆpromptï¼‰"
    patterns:
      - "å¯¹è¯æ¡†è¾“å…¥~{text}"
    template: |
      await (async () => {
        $page.once('dialog', dialog => dialog.accept('{text}'));
        return true;
      })()
    validation:
      required: ["text"]

  # ==========================================================================
  # ç½‘ç»œç›¸å…³
  # ==========================================================================

  - name: "wait_for_response"
    description: "ç­‰å¾…æŒ‡å®š URL çš„å“åº”"
    patterns:
      - "ç­‰å¾…å“åº”~{urlPattern}"
      - "ç­‰å¾…æ¥å£~{urlPattern}"
    template: |
      await $page.waitForResponse(response => response.url().includes('{urlPattern}'), { timeout: 30000 })
    validation:
      required: ["urlPattern"]

  - name: "wait_for_request"
    description: "ç­‰å¾…æŒ‡å®š URL çš„è¯·æ±‚"
    patterns:
      - "ç­‰å¾…è¯·æ±‚~{urlPattern}"
    template: |
      await $page.waitForRequest(request => request.url().includes('{urlPattern}'), { timeout: 30000 })
    validation:
      required: ["urlPattern"]

  # ==========================================================================
  # è§†å£ä¸è®¾å¤‡æ¨¡æ‹Ÿ
  # ==========================================================================

  - name: "set_viewport"
    description: "è®¾ç½®è§†å£å¤§å°"
    patterns:
      - "è®¾ç½®è§†å£~{width}~{height}"
      - "è®¾ç½®åˆ†è¾¨ç‡~{width}~{height}"
    template: |
      await $page.setViewportSize({ width: parseInt('{width}'), height: parseInt('{height}') })
    validation:
      required: ["width", "height"]
    examples:
      - "è®¾ç½®è§†å£~1920~1080"

  # ==========================================================================
  # æ€§èƒ½ä¸è°ƒè¯•
  # ==========================================================================

  - name: "get_performance"
    description: "è·å–é¡µé¢æ€§èƒ½æŒ‡æ ‡"
    patterns:
      - "è·å–æ€§èƒ½æŒ‡æ ‡"
      - "æ€§èƒ½åˆ†æ"
    template: |
      await (async () => {
        const metrics = await $page.evaluate(() => {
          const perf = window.performance;
          const timing = perf.timing;
          return {
            domContentLoaded: timing.domContentLoadedEventEnd - timing.navigationStart,
            loadComplete: timing.loadEventEnd - timing.navigationStart,
            firstPaint: perf.getEntriesByType('paint')[0]?.startTime || 0
          };
        });
        return metrics;
      })()
    validation:
      required: []

  - name: "log_console"
    description: "ç›‘å¬å¹¶è®°å½•æ§åˆ¶å°æ¶ˆæ¯"
    patterns:
      - "ç›‘å¬æ§åˆ¶å°"
      - "è®°å½•æ—¥å¿—"
    template: |
      await (async () => {
        const logs = [];
        $page.on('console', msg => logs.push({ type: msg.type(), text: msg.text() }));
        return logs;
      })()
    validation:
      required: []

  # ==========================================================================
  # æ•°æ®ä¿å­˜
  # ==========================================================================

  - name: "save_json"
    description: "ä¿å­˜æ•°æ®ä¸º JSON æ–‡ä»¶"
    patterns:
      - "ä¿å­˜JSON~{filename}~{data}"
      - "å¯¼å‡ºJSON~{filename}~{data}"
    template: |
      await (async () => {
        fs.mkdirSync('results/data', { recursive: true });
        const filePath = path.join(process.cwd(), 'results/data', '{filename}.json');
        fs.writeFileSync(filePath, JSON.stringify({data}, null, 2));
        console.log(\`   ğŸ’¾ æ•°æ®å·²ä¿å­˜: \${filePath}\`);
        return filePath;
      })()
    validation:
      required: ["filename", "data"]

  - name: "read_json"
    description: "è¯»å– JSON æ–‡ä»¶"
    patterns:
      - "è¯»å–JSON~{filename}"
    template: |
      await (async () => {
        const filePath = path.join(process.cwd(), 'results/data', '{filename}.json');
        const data = JSON.parse(fs.readFileSync(filePath, 'utf8'));
        return data;
      })()
    validation:
      required: ["filename"]

  # ==========================================================================
  # AI ä»£ç†ä»»åŠ¡
  # ==========================================================================

  - name: "default_agent"
    description: "AI ä»£ç†æ‰§è¡Œå¤æ‚ä»»åŠ¡é“¾"
    patterns:
      - "ä»£ç†~{action}"
      - "æ™ºèƒ½æ‰§è¡Œ~{action}"
    template: |
      await $stagehand.agent('{action}')
    validation:
      required: ["action"]
    examples:
      - "ä»£ç†~ç™»å½•ç³»ç»Ÿå¹¶æ‰¾åˆ°æœ€æ–°çš„è®¢å•"
      - "æ™ºèƒ½æ‰§è¡Œ~å¡«å†™è¡¨å•å¹¶æäº¤"

  # ==========================================================================
  # è‡ªå®šä¹‰è„šæœ¬
  # ==========================================================================

  - name: "default_script"
    description: "æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬å—"
    patterns:
      - "è„šæœ¬~{script}"
    template: |
      await (async () => { {script} })()
    validation:
      required: ["script"]
    examples:
      - "è„šæœ¬~const text = await $page.locator('h1').textContent(); console.log(text);"

  # ==========================================================================
  # é»˜è®¤ AI æ“ä½œï¼ˆå…œåº•è§„åˆ™ï¼‰
  # ==========================================================================

  - name: "default_act"
    description: "é»˜è®¤ AI é©±åŠ¨æ“ä½œï¼ˆå½“æ— å…¶ä»–è§„åˆ™åŒ¹é…æ—¶ï¼‰"
    patterns:
      - "{action}"
    template: |
      await $stagehand.act('{action}', $page)
    validation:
      required: ["action"]
    examples:
      - "æ‰¾åˆ°ç™»å½•æŒ‰é’®å¹¶ç‚¹å‡»"
      - "æ»šåŠ¨åˆ°é¡µé¢åº•éƒ¨"

# ============================================================================
# ä½¿ç”¨ç¤ºä¾‹
# ============================================================================
#
# åŸºç¡€æµ‹è¯•æµç¨‹ç¤ºä¾‹ï¼š
# 
# 1. æ‰“å¼€~https://example.com
# 2. åœ¨ç”¨æˆ·åä¸­è¾“å…¥~admin
# 3. åœ¨å¯†ç ä¸­è¾“å…¥~password123
# 4. ç‚¹å‡»~ç™»å½•æŒ‰é’®
# 5. ç­‰å¾…~2000~æ¯«ç§’
# 6. æ–­è¨€URLåŒ…å«~dashboard
# 7. æˆªå›¾~ä¿å­˜ä¸º~dashboard-page
# 8. æ‘˜å½•~æå–é¡µé¢æ ‡é¢˜
#
# é«˜çº§æµ‹è¯•ç¤ºä¾‹ï¼ˆå¤šæ ‡ç­¾é¡µï¼‰ï¼š
# 
# 1. æ‰“å¼€~https://example.com
# 2. æ–°å»ºæ ‡ç­¾é¡µ~https://example.com/about
# 3. åˆ—å‡ºæ‰€æœ‰æ ‡ç­¾é¡µ
# 4. åˆ‡æ¢åˆ°æ ‡ç­¾é¡µ~About
# 5. æ–­è¨€æ ‡é¢˜~About Us
# 6. å…³é—­æ ‡ç­¾é¡µ~About
#
# è¡¨å•éªŒè¯ç¤ºä¾‹ï¼š
#
# 1. æ‰“å¼€~https://example.com/form
# 2. å¡«å……~#email~test@example.com
# 3. å‹¾é€‰~#terms
# 4. é€‰æ‹©~#country~China
# 5. æ–­è¨€å·²é€‰ä¸­~#terms
# 6. æ–­è¨€å±æ€§~#email~value~test@example.com
# 7. ç‚¹å‡»~æäº¤æŒ‰é’®
# 8. ç­‰å¾…å“åº”~/api/submit
# 9. æ–­è¨€åŒ…å«æ–‡æœ¬~.success~æäº¤æˆåŠŸ
#
# æ•°æ®æå–ç¤ºä¾‹ï¼š
#
# 1. æ‰“å¼€~https://example.com/products
# 2. æ‘˜å½•~æå–æ‰€æœ‰äº§å“ä¿¡æ¯~z.array(z.object({name: z.string(), price: z.number()}))
# 3. ä¿å­˜JSON~products~$result
#
# å¤æ‚åœºæ™¯ç¤ºä¾‹ï¼ˆAI ä»£ç†ï¼‰ï¼š
#
# 1. æ‰“å¼€~https://example.com
# 2. ä»£ç†~ç™»å½•ç³»ç»Ÿï¼Œæ‰¾åˆ°è®¾ç½®é¡µé¢ï¼Œæ›´æ”¹è¯­è¨€ä¸ºä¸­æ–‡ï¼Œç„¶åé€€å‡º
#
# ============================================================================